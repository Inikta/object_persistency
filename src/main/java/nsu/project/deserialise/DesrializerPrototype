package nsu.project.deserialise;
import org.json.JSONArray;
import org.json.JSONObject;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

public class DesrializerPrototype {
    private static Map<String, Person> peopleMap = new HashMap<>();
    private static Map<String, Building> buildingsMap = new HashMap<>();
    private static Map<String, Boolean> visitedPeople = new HashMap<>();
    private static Map<String, Boolean> visitedBuildings = new HashMap<>();

    public static void main(String[] args) {
        try {
            // Чтение содержимого файла JSON
            String json_data = new String(Files.readAllBytes(Paths.get("data.json")));

            // Парсинг JSON-данных
            JSONObject data = new JSONObject(json_data);

            // Создание объектов Person и Building
            personCreate(data);
            buildingCreate(data);

            // Вывод информации о людях и зданиях
            System.out.println("People:");
            for (Person person : peopleMap.values()) {
                System.out.println(person.toString());
            }

            System.out.println("Buildings:");
            for (Building building : buildingsMap.values()) {
                System.out.println(building.toString());
            }

        } catch (IOException e) {
            System.err.println("Failed to read file: " + e.getMessage());
        }
    }

    private static void personCreate(JSONObject data) {
        JSONObject peopleObject = data.getJSONArray("Person").getJSONObject(0);
        for (String personKey : peopleObject.keySet()) {
            if (peopleMap.containsKey(personKey) || visitedPeople.containsKey(personKey)) {
                continue;
            }

            JSONObject personInfo = peopleObject.getJSONObject(personKey);
            String personName = personInfo.getString("name");
            String personSurname = personInfo.getString("surname");
            int personAge = personInfo.getInt("age");
            String personHome = personInfo.optString("home", null); // Используем optString для получения значения или null

            visitedPeople.put(personKey, true);

            Building homeBuilding = personHome != null ? new Building(personHome, null) : null;
            Person person = new Person(personName, personSurname, personAge, homeBuilding);
            peopleMap.put(personKey, person);
        }
    }

    private static void buildingCreate(JSONObject data) {
        JSONObject buildingsObject = data.getJSONArray("Buildings").getJSONObject(0);
        for (String buildingKey : buildingsObject.keySet()) {
            if (buildingsMap.containsKey(buildingKey) || visitedBuildings.containsKey(buildingKey)) {
                continue;
            }

            JSONObject buildingInfo = buildingsObject.getJSONObject(buildingKey);
            String buildingAddress = buildingInfo.getString("address");
            List<Person> buildingResidents = new ArrayList<>();
            JSONArray citizensIds = buildingInfo.getJSONArray("citizens");
            for (int i = 0; i < citizensIds.length(); i++) {
                String citizenId = citizensIds.getString(i);
                Person resident = peopleMap.get(citizenId);
                if (resident != null) {
                    buildingResidents.add(resident);
                }
            }

            visitedBuildings.put(buildingKey, true);
            Building building = buildingResidents.isEmpty() ? new Building(buildingAddress, null) : new Building(buildingAddress, buildingResidents);
            buildingsMap.put(buildingKey, building);
        }
    }
}
